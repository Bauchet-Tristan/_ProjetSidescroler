<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>yin and Yang</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var config = {
    type: Phaser.AUTO,
    width: 3840,
    height: 2160,
    physics: {
        default: 'arcade',
        arcade: {
            gravity: { y: 900 },
            debug: true
        }
    },
    input:{gamepad:true},
    scene: {
        preload: preload,
        create: create,
        update: update
    }
};

var hitBox;
var hitBoxLeft;
var hitBoxRight;

var hitLeft = 0;
var hitRight = 0;

// Move Condition
var platforms;
var platformsICE;
var platformsSNOW;
var wall;
var ICE = false;
var SNOW = false;

//// Stat wolf ////
var wolf;
var timeMove = 0;
var speedWolf = 150; 


//// Stat joueur ////
var player;

// Life //
var lifeMax = 6;
var life = 6;
var yin1;
var yin2;
var yin3;
var yin4;
var yin5;
var yin6;
var timerNoDamage = 0;
var timerInvincibleFrame =0;

// Spirit //
var spiritMax =6;
var spirit = 6;
var yang1;
var yang2;
var yang3;
var yang4;
var yang5;
var yang6;

// Speed //
var currentSpeed;
var speed = 250;
var speedICE = 300;
var speedSNOW = 120;


////  Compteurs ////

//Saut//
var jump1 = 0;
var jump2 = 0;
var jumpAerien = 0;
var wallJumpLeft = 0;
var wallJumpRight = 0;
var timeWalljump = 0;
var jumpIsUp = 1;

//Dash attack
var dashAttackLeft = 0;
var dashAttackRight = 0;
var dashAerien = 0;
var tempDash = 0;
var lastMove = 0;

//  Input Events  //
var cursors;
var keyA;

//  Input Events Pad //
var paddleConnected = false ;
var paddle;

// GAME //
var gameOver = false;
var game = new Phaser.Game(config);



function preload ()
{
    this.load.image('hitBox', 'assets/hitBox.png');
    this.load.image('hitBox2', 'assets/hitBox2.png');

    this.load.image('life', 'assets/Yin.png');
    this.load.image('spirit', 'assets/Yang.png');

    this.load.image('sky', 'assets/fond-2.png');
    

    this.load.image('wall', 'assets/rock.png');
    this.load.image('ground', 'assets/platform.png');
    this.load.image('groundICE', 'assets/platformICE.png');
    this.load.image('groundSNOW', 'assets/platformSNOW.png');

    this.load.spritesheet('dude', 'assets/dude.png', { frameWidth: 32, frameHeight: 48 });
    this.load.spritesheet('wolf', 'assets/wolf.png', { frameWidth: 32, frameHeight: 48 });
}



function create ()
{
  
    //  A simple background for our game
    this.add.image(1920, 1080, 'sky');

    //  The platforms group contains the ground and the ledges we can jump on
    platforms = this.physics.add.staticGroup();
    platformsICE = this.physics.add.staticGroup();
    platformsSNOW = this.physics.add.staticGroup();
    wall = this.physics.add.staticGroup();

    // Plateforms horizontal
    platforms.create(400, 568, 'ground').setScale(2).refreshBody(); // LE SOL
    platformsSNOW.create(600, 410, 'groundSNOW'); // Plateform 1
    platformsICE.create(80, 250, 'groundICE'); // Plateform 2 
    platforms.create(740, 220, 'ground'); // Plateform 3

    // Plateforms vertical
    wall.create(300,250, 'wall').setScale(0.7).refreshBody(); // Plateform Verticale
    wall.create(450,150, 'wall').setScale(0.7).refreshBody(); // Plateform Verticale

    // The player and its settings
    player = this.physics.add.sprite(375, 500, 'dude');
    player.setCollideWorldBounds(true);
    



    hitBoxRight = this.physics.add.image(0,0,'hitBox2');
    hitBoxLeft = this.physics.add.image(0,0,'hitBox2'); 


    //Wolf
    wolf = this.physics.add.sprite(500, 500, 'wolf');
    wolf.setCollideWorldBounds(true);


    //  Our player animations, turning, walking left and walking right.
    this.anims.create({
        key: 'left',
        frames: this.anims.generateFrameNumbers('dude', { start: 0, end: 3 }),
        frameRate: 10,
        repeat: -1
    });

    this.anims.create({
        key: 'turn',
        frames: [ { key: 'dude', frame: 4 } ],
        frameRate: 20
    });

    this.anims.create({
        key: 'right',
        frames: this.anims.generateFrameNumbers('dude', { start: 5, end: 8 }),
        frameRate: 10,
        repeat: -1
    });


    //  Input Events  //
    cursors = this.input.keyboard.createCursorKeys();
    keyA = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A);
    ////// end Input //////


///////////////////////////////        UI        /////////////////////////////// 

    //Camera
    this.cameras.main.setSize(1920,1080);
    
    // Life
    yin1 = this.add.image(0, 0, 'life');  
    yin2 = this.add.image(0, 0, 'life');  
    yin3 = this.add.image(0, 0, 'life');  
    yin4 = this.add.image(0, 0, 'life');  
    yin5 = this.add.image(0, 0, 'life');  
    yin6 = this.add.image(0, 0, 'life');  

    // Spirit
    yang1 = this.add.image(0, 0, 'spirit');  
    yang2 = this.add.image(0, 0, 'spirit');  
    yang3 = this.add.image(0, 0, 'spirit');  
    yang4 = this.add.image(0, 0, 'spirit');  
    yang5 = this.add.image(0, 0, 'spirit');  
    yang6 = this.add.image(0, 0, 'spirit');



////////////////////////////////////        COLLIDER        ////////////////////////////////////      


/////// Platforms Collider ///////

    // collide with wolf
    this.physics.add.collider(wolf, platforms);

    // Collide the player with the platforms Green
    this.physics.add.collider(player, platforms,GroundGreen);
    
    // Collide the player with the platforms ICE
    this.physics.add.collider(player, platformsICE,GroundBlue);

    // Collide the player with the platforms SNOW 
    this.physics.add.collider(player, platformsSNOW,GroundWhite);

    // Collide th player with wall for wall jump
    this.physics.add.collider(player,wall);

    //
    //this.physics.add.overlap(hitBoxLeft, wall,WallJumpLeft);
    this.physics.add.overlap(hitBoxRight, wall,WallJumpRight);
    this.physics.add.overlap(hitBoxLeft, wall,WallJumpLeft);

    /////// Ennemi Collider ///////
    this.physics.add.overlap(player, wolf,PlayerWolf);
}


/*/                                                       FUNCTION-UPDATE                                                      /*/


function update ()
{

///////////////////////////////////////////////////

    this.input.gamepad.once('connected',function(pad)
    {
        paddleConnected = true ;
        paddle = pad;
    });

///////////////////////////////////////////////////

    if (gameOver)
    {
        this.physics.pause();

        player.setTint(0xff0000);

        player.anims.play('turn');

        return;
    }

///////////////////////////////////////////////////

    timerNoDamage = timerNoDamage +1;
    UX();
    hitBoxWall();

/////////////////////////////////////  Camera - Interface  /////////////////////////////////////

    this.cameras.main.startFollow(player,false,0,0,-225,100);

///////////////////////////////////////////////////////  Ennemie  ////////////////////////////////////////////////////////////

    // Ennemi patern
    
    timeMove = timeMove+1;

    if(timeMove <= 150)
    {
        wolf.setVelocityX(-160);
    }
    else if(timeMove > 150 && timeMove <= 300)
    {
        wolf.setVelocityX(0);
    }

    else if(timeMove > 300 && timeMove <= 450)
    {
        wolf.setVelocityX(160);
    } 
    else if(timeMove > 450 && timeMove <= 600)
    {
        wolf.setVelocityX(0);
    } 
    else
    {
        timeMove =  0;
    }

///////////////////////////////////////////////////////  Control Clavier /////////////////////////////////////////////////////

    
    if (paddleConnected == false)
    {
        if (cursors.left.isDown)
        {
            lastMove = "left";
        }
        if (cursors.right.isDown)
        {
            lastMove = "right";
        }
        
        if (ICE == false)
        {
            if (cursors.left.isDown)
            {
                player.setVelocityX(-250);
                player.anims.play('left', true);
            }
            else if (cursors.right.isDown)
            {
                player.setVelocityX(250);
                player.anims.play('right', true);
            }
            else
            {
                player.setVelocityX(0);
                player.setAccelerationX(0);
                player.anims.play('turn');
            }
        }

////////////////////////////////////////// ICE //////////////////////////////////////////
        else if (ICE == true)
        {
            if (cursors.left.isDown)
            {
                player.setAccelerationX(-150);
                player.anims.play('left', true);
            }
            else if (cursors.right.isDown)
            {
                player.setAccelerationX(150);
                player.anims.play('right', true);
            }
            else
            {
                player.setAccelerationX(-0);
                player.anims.play('turn');
            }
        }
        
        if(SNOW == true)
        {
            if (cursors.left.isDown)
            {
                player.setVelocityX(-125);
                player.anims.play('left', true);
            }
            else if (cursors.right.isDown)
            {
                player.setVelocityX(125);
                player.anims.play('right', true);
            }
            else
            {
                player.setVelocityX(0);
                player.setAccelerationX(0);
                player.anims.play('turn');
            }
        }
        
        Saut();

        //---------------// Dash Down //---------------//
        if (!player.body.touching.down && cursors.down.isDown)
        {
            player.setVelocityY(400);
        }

        Dash();
    } 



//////////////////////////////////////////////////////////  Control manette //////////////////////////////////////////////////////////

  
    if (paddleConnected == true)
    {
        if (paddle.left )
        {
            player.setVelocityX(-160);

            player.anims.play('left', true);
        }
        
        else if (paddle.right )
        {
            player.setVelocityX(160);

            player.anims.play('right', true);
        }
        
        else
        {
            player.setVelocityX(0);

            player.anims.play('turn');
        }

        if (player.body.touching.down && paddle.A)
        {
            player.setVelocityY(-330);
        }
    }

    RESET();
           
}

function RESET()
{
    hitLeft = 0;
    hitRight = 0;
}

function UX ()
{
    //frame invulerabilité
    if (timerNoDamage <= 210)
    {
        player.setTint(0x0f00f0);
    }

    else 
    {
        player.setTint(0xffffff);
    }
    
    //////// Barre de Vie ////////

    ////
    yin1.x = player.body.position.x + 70;
    yin1.y = player.body.position.y + 330;

    yin2.x = player.body.position.x + 145;
    yin2.y = player.body.position.y + 330;

    /////
    yin3.x = player.body.position.x + 220;
    yin3.y = player.body.position.y + 330;
    
    yin4.x = player.body.position.x + 295;
    yin4.y = player.body.position.y + 330;

    ////
    yin5.x = player.body.position.x + 370;
    yin5.y = player.body.position.y + 330;

    yin6.x = player.body.position.x + 445;
    yin6.y = player.body.position.y + 330;

////////////////////////////////////////// Actualisation barre de Vie ////////////////////////////////////////// 

    if(life <= 0)
    {
        yin1.setAlpha(0);
        gameOver = true;
    }

    if(life <= 1)
    {
        yin2.setAlpha(0);
    }

    if(life <= 2)
    {
        yin3.setAlpha(0);
    }

    if(life <= 3)
    {
        yin4.setAlpha(0);
    }

    if(life <= 4)
    {
        yin5.setAlpha(0);
    }

    if(life <= 5)
    {
        yin6.setAlpha(0);
    }



//////// Barre Spirit ////////

    ////
    yang1.x = player.body.position.x - 38;
    yang1.y = player.body.position.y + 330;

    yang2.x = player.body.position.x - 113;
    yang2.y = player.body.position.y + 330;

    /////
    yang3.x = player.body.position.x - 188;
    yang3.y = player.body.position.y + 330;
    
    yang4.x = player.body.position.x - 263;
    yang4.y = player.body.position.y + 330;

    ////
    yang5.x = player.body.position.x - 338;
    yang5.y = player.body.position.y + 330;

    yang6.x = player.body.position.x - 413;
    yang6.y = player.body.position.y + 330;
}


function PlayerWolf ()
{   
    if(dashAttackRight == 1 || dashAttackLeft == 1)
    {
        wolf.disableBody(true, true);    
    }
    else
    {
        GroundBlue();
        if (player.body.position.x >= wolf.body.position.x)
        {
            //console.log("PlayerX plus grand");
            player.setVelocityY(-200);
            player.setVelocityX(200);
        }
        else if(player.body.position.x <= wolf.body.position.x)
        {
            //console.log("PlayerX plus petit");
            player.setVelocityY(-200);
            player.setVelocityX(-200);
        }
        LoseLife();
    }
} 

function LoseLife () /////////////////ergrdegf/////////////////
{
    if ( timerNoDamage > 210)
    {
        //console.log("frame d'invulnerabilité END END");
        timerNoDamage = 0;
    }

    if(timerNoDamage == 0 )
    {
        //console.log("Perte de vie");
        life = life - 1  
    }
    else if(timerNoDamage <= 210 )
    {   
        //console.log("frame d'invulnerabilité");
    }
}

function GroundGreen ()
{
    ICE = false; 
    SNOW = false;     
} 

function GroundBlue ()
{
    ICE = true; 
    SNOW = false; 
}    

function GroundWhite ()
{
    ICE = false;
    SNOW = true; 
}  





function Saut()
{
    //---------------// Saut //---------------//
    if(player.body.touching.down && cursors.space.isDown && jumpIsUp == 1)
    {
        player.setVelocityY(-450); 
        jump1 = 1;
        jumpIsUp = 0;
    }        

    //---------------// Check relache Space ET debloque le deuxieme saut//---------------//   
    if(cursors.space.isUp && jump1 == 1 )
    {
        jump2 = 1;
        jumpIsUp = 1;
    }

    //---------------// Check si en l'air sans utiliser Saut 1 ET debloque le deuxieme saut//---------------//   
    if (!player.body.touching.down && jumpAerien == 0 && jump1 == 0)
    {
        jump1 = 1;
        jumpAerien = 1;
        jump2 = 1;
    }

    //---------------// Double Saut //---------------//  
    if (!player.body.touching.down && cursors.space.isDown && jump2 == 1 && (wallJumpRight == 0 && wallJumpLeft == 0)) // quand on re APPUIS
    {
        player.setVelocityY(-350);
        jump1 = 0;
        jump2 = 0;
        jumpAerien = 1;
        GroundGreen();
    }

    //---------------// reset si on a pas utiliser notre double saut //---------------// 
    if (player.body.touching.down && jump2 == 1 )
    {
        jump1 = 0;
        jump2 = 0;
    }

    //---------------// reset si on a pas utiliser notre sautAerien //---------------// 
    if (player.body.touching.down && jumpAerien == 1 )
    {
        jumpAerien =0;
    }

///////////////////////////////////////// WALL JUMP /////////////////////////////////////////

    if(hitLeft!=0 && cursors.space.isDown )
    {
        //console.log("touche gauche");
        wallJumpRight = 1;
    }

    if(hitRight !=0 && cursors.space.isDown )
    {
        //console.log("touche droite");
        wallJumpLeft = 1;
    }


    if ((wallJumpRight == 1 || wallJumpLeft == 1) && timeWalljump <= 27)
    {
        GroundGreen();
        if(timeWalljump==0)
        {
            player.setVelocityX(0);
            player.setAccelerationX(0);
            player.setVelocityY(-260);
        }

        if (wallJumpRight == 1)
        {
            //console.log("saut a droite");
            player.setVelocityX(400);
            
            if(hitRight != 0)
            {
                console.log("saut a droite");
                timeWalljump = 27;
            }
        }
        
        if (wallJumpLeft == 1)
        {
            //console.log("saut a gauche");
            player.setVelocityX(-400);

            if(hitLeft != 0)
            {
                console.log("saut a gauche");
                timeWalljump = 27;
            }
        }
        timeWalljump++;
    }

    //wall jump compteur reset
    if (cursors.space.isUp && timeWalljump >= 27 && (wallJumpRight == 1 || wallJumpLeft == 1)) 
    {
        //console.log("RESET !!");
        wallJumpLeft = 0;
        wallJumpRight = 0;
        timeWalljump = 0;
    }
}

function WallJumpLeft()
{
    console.log("left");
    hitLeft = 1;
}

function WallJumpRight()
{
    console.log("right");
    hitRight = 1;
}

function hitBoxWall()
{
    //hitBoxRight.setAlpha(0);
    hitBoxRight.setVelocityY(0);
    hitBoxRight.setVelocityX(0);
    hitBoxRight.x = player.x +22; 
    hitBoxRight.y = player.y; 
    hitBoxRight.body.position.x = player.body.position.x +32;
    hitBoxRight.body.position.y = player.body.position.y+9;

    //hitBoxLeft.setAlpha(0);
    hitBoxLeft.setVelocityY(0);
    hitBoxLeft.setVelocityX(0);
    hitBoxLeft.x = player.x -20; 
    hitBoxLeft.y = player.y; 
    hitBoxLeft.body.position.x = player.body.position.x -10;
    hitBoxLeft.body.position.y = player.body.position.y+9;
}


function Dash()
{
    //---------------// Dash attack //---------------//

    if (dashAerien == 0)
    {
        //Regarde si on veut dash a gauche ou a droite
        if (lastMove == "right" && keyA.isDown && (dashAttackRight == 0 || dashAttackLeft == 0))
        { 
            dashAttackRight = 1;
        }

        if (lastMove == "left" && keyA.isDown && (dashAttackRight == 0 || dashAttackLeft == 0))
        { 
            dashAttackLeft = 1;
        }

        //Dash
        if ((dashAttackRight == 1 || dashAttackLeft == 1) && tempDash < 9)
        {
            if (dashAttackRight == 1)
            {
                player.setVelocityX(1700);
            }
            else if (dashAttackLeft == 1)
            {
                player.setVelocityX(-1700);
            }
            tempDash++;
        }

        //Apres le dash reset notre vitesse 
        else if (tempDash==9) 
        {
            player.setVelocityX(0);
            player.setAccelerationX(0);
            GroundGreen();
            tempDash=10;
        }

        //Met a jour les compteurs des dashs
        if (keyA.isUp && tempDash >= 10 && (dashAttackRight == 1 || dashAttackLeft == 1)) 
        {
            dashAttackLeft = 0;
            dashAttackRight = 0;
            tempDash = 0;
            dashAerien = 1;
        }
    }

    if (!player.body.touching.down && dashAerien== 1)
    {

    }
    else if (player.body.touching.down && dashAerien== 1)
    {
        dashAerien = 0;
    }
}

</script>
</body>
</html>